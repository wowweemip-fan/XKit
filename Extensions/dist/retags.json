{"id":"retags","script":"//* TITLE       Retags **//\n//* DEVELOPER   new-xkit **//\n//* VERSION     1.2.5 **//\n//* DESCRIPTION Adds tags to reblog notes **//\n//* FRAME       false **//\n//* SLOW        false **//\n//* BETA        false **//\n\nXKit.extensions.retags = {\n\trunning: false,\n\tapi_key: XKit.api_key,\n\tselectors: '.type_2,.type_8,.type_6,.reblog:not(.ui_avatar_link, .retags_has_processed),.is_reblog,.is_reblog_naked,.notification_reblog,.is_reply,.is_answer,.is_user_mention,.notification_user_mention',\n\tblog_name: \"\",\n\n\trun: function() {\n\t\tthis.running = true;\n\t\tXKit.tools.init_css(\"retags\");\n\t\ttry {\n\t\t\tthis.blog_name = $('body').data('new-root').split('/').pop();\n\t\t} catch (e) {}\n\t\tthis.add_toggle();\n\t\tthis.observer.observe($('body')[0], {\n\t\t\tchildList:true,\n\t\t\tsubtree:true\n\t\t});\n\t\tthis.tag(this.selectors);\n\t},\n\n\tobserver: new MutationObserver(function(ms) {\n\t\tvar notesProcessed = false;\n\t\tms.forEach(function(mutation) {\n\t\t\tvar $baseMutatedElements = $(mutation.addedNodes);\n\t\t\tvar activityNotes = $baseMutatedElements.find('.activity-notification');\n\t\t\tvar fallbackNotes = $baseMutatedElements.find('.note:not(.ui_post_badge)');\n\t\t\tif ($baseMutatedElements.hasClass('note-list')) {\n\t\t\t\t//remove existing retags items (if tabbing between popover views)\n\t\t\t\t$baseMutatedElements.find('.retags-wrapper').remove();\n\t\t\t\tvar elements = $baseMutatedElements.find('.post-activity-note');\n\t\t\t\tnotesProcessed = true;\n\t\t\t\tXKit.extensions.retags.tag_popover(elements.filter(XKit.extensions.retags.selectors));\n\t\t\t} else if ($baseMutatedElements.hasClass('post-activity-note') && !notesProcessed) {\n\t\t\t\tXKit.extensions.retags.tag_popover($baseMutatedElements.filter(XKit.extensions.retags.selectors));\n\t\t\t} else if (activityNotes.length > 0) {\n\t\t\t\tXKit.extensions.retags.tag(activityNotes.filter(XKit.extensions.retags.selectors));\n\t\t\t} else if (fallbackNotes.length > 0) {\n\t\t\t\tXKit.extensions.retags.tag(fallbackNotes.filter(XKit.extensions.retags.selectors));\n\t\t\t} else {\n\t\t\t\tXKit.extensions.retags.tag($baseMutatedElements.filter(XKit.extensions.retags.selectors));\n\t\t\t}\n\t\t});\n\t}),\n\n\ttag_popover: function(elements) {\n\t\t$(elements).each(function() {\n\t\t\tvar $element = $(this), retagClass, $target, host, id;\n\t\t\tif ($element.find('div.retags, p.note-added-tags').length) {\n\t\t\t\treturn false;\n\t\t\t}\n\t\t\tif ($element.is('.is_reply, .is_answer, .type_6')) {\n\t\t\t\treturn;\n\t\t\t}\n\t\t\t// popover\n\t\t\tif ($element.hasClass('note-item')) {\n\t\t\t\tretagClass = 'with_commentary';\n\t\t\t\t$target = $element;\n\t\t\t\tvar peepr_data = $target.find('.note-text-link').data('peepr');\n\t\t\t\tif (peepr_data) {\n\t\t\t\t\thost = peepr_data.tumblelog.trim() + '.tumblr.com';\n\t\t\t\t\tid = peepr_data.postId.trim();\n\t\t\t\t}\n\t\t\t}\n\t\t\tif (host && id) {\n\t\t\t\tXKit.extensions.retags.request(host, id).then(function(tags) {\n\t\t\t\t\tXKit.extensions.retags.append_tag_popover($element, retagClass, $target, tags);\n\t\t\t\t}).fail(function(errorResponse) {\n\t\t\t\t\tvar tagError = 'ERROR: ' + errorResponse.status;\n\t\t\t\t\tXKit.extensions.retags.append_tag_popover($element, retagClass, $target, tagError);\n\t\t\t\t});\n\t\t\t}\n\t\t});\n\t},\n\n\tappend_tag_popover: function($element, retagClass, $target, data) {\n\t\tif (!data || !data.length) {\n\t\t\treturn;\n\t\t}\n\t\tvar retags = XKit.extensions.retags.build_tag_collection($element, retagClass, data);\n\t\tretags = \"<li class='retags-wrapper'>\" + retags[0].outerHTML + \"</li>\";\n\t\t$target.after(retags);\n\t},\n\n\ttag: function(elements) {\n\t\t$(elements).each(function() {\n\t\t\tvar $element = $(this).addClass(\"retags_has_processed\"), retagClass, $target, url, host, id;\n\t\t\tif ($element.find('div.retags').length) {\n\t\t\t\treturn false;\n\t\t\t}\n\t\t\t//we don't need to put tags on a reply, but we also don't need to hide it\n\t\t\tif ($element.is('.is_reply, .is_answer, .type_6')) {\n\t\t\t\treturn;\n\t\t\t}\n\t\t\t//blog\n\t\t\tif ($element.hasClass('note')) {\n\t\t\t\t   retagClass = 'with_commentary';\n\t\t\t\t   $target = $element;\n\t\t\t\t   url = $target.find('.action').data('post-url');\n\t\t\t// Activity (page/dropdown)\n\t\t\t} else if ($element.hasClass('activity-notification')) {\n\t\t\t\tretagClass = 'is_retags';\n\t\t\t\t$target = $element;\n\t\t\t\tvar glass = $($element).find('.activity-notification__glass');\n\t\t\t\turl = glass.attr('href');\n\t\t\t\t// dashboard\n\t\t\t} else if ($element.hasClass('notification') && !XKit.browser().mobile) {\n\t\t\t\t$target = $element.find('.notification_sentence');\n\t\t\t\turl = $target.find('.notification_target').attr('href');\n\t\t\t// mobile\n\t\t\t} else if ($element.hasClass('notification') && XKit.browser().mobile) {\n\t\t\t\tretagClass = 'is_retags';\n\t\t\t\t$target = $element.find('.notification-wrapper');\n\t\t\t\turl = $target.find('a').not('.notification-username').attr('href');\n\t\t\t}\n\t\t\tif (url) {\n\t\t\t\turl = url.split('/');\n\t\t\t\thost = url[2];\n\t\t\t\tid = url[4];\n\t\t\t\tXKit.extensions.retags.request(host, id).then(function(tags) {\n\t\t\t\t\tXKit.extensions.retags.append_tag($element, retagClass, $target, tags);\n\t\t\t\t}).fail(function(errorResponse) {\n\t\t\t\t\tvar tagError = 'ERROR: ' + errorResponse.status;\n\t\t\t\t\tXKit.extensions.retags.append_tag($element, retagClass, $target, tagError);\n\t\t\t\t});\n\t\t\t}\n\t\t});\n\t},\n\n\tappend_tag: function($element, retagClass, $target, data) {\n\t\tvar retags = XKit.extensions.retags.build_tag_collection($element, retagClass, data);\n\t\t$target.append(retags);\n\t},\n\n\trequest: function(host, id) {\n\t\tvar url = 'https://api.tumblr.com/v2/blog/' + host + '/posts/info?id=' + id + '&api_key=' + XKit.extensions.retags.api_key;\n\t\tvar cache_label = 'post_' + id;\n\t\t//if it's already cached, get from cache\n\t\tif (XKit.storage.get('retags', cache_label, null) !== null) {\n\t\t\treturn $.Deferred().resolve(XKit.storage.get('retags', cache_label));\n\t\t}\n\t\t//otherwise make API call\n\t\tvar tags = [];\n\t\tvar deferred = $.Deferred();\n\t\tGM_xmlhttpRequest({\n\t\t\tmethod: 'GET',\n\t\t\turl: url,\n\t\t\tonload: function(data) {\n\t\t\t\ttags = JSON.parse(data.responseText).response.posts[0].tags;\n\t\t\t\tif (XKit.extensions.retags.should_clear_posts()) {\n\t\t\t\t\tXKit.extensions.retags.clear_old_posts();\n\t\t\t\t}\n\t\t\t\tXKit.storage.set('retags', cache_label, tags);\n\t\t\t\tdeferred.resolve(tags);\n\t\t\t},\n\t\t\tonerror: function(error) {\n\t\t\t\tdeferred.reject(error);\n\t\t\t}\n\t\t});\n\t\treturn deferred;\n\t},\n\n\tbuild_tag_collection: function($element, retagClass, tags) {\n\t\tif (tags.length) {\n\t\t\tvar $retags = $('<div class=\"retags\">');\n\t\t\tif (typeof tags === 'string') {\n\t\t\t\t$retags.append(tags).addClass('error');\n\t\t\t} else {\n\t\t\t\ttags.forEach(function(tag) {\n\t\t\t\t\t$retags.append('<a href=\"//tumblr.com/tagged/' + tag.replace(/ /g, '-') + '\">#' + tag + '</a>');\n\t\t\t\t});\n\t\t\t}\n\t\t\t$element.addClass(retagClass);\n\t\t\treturn $retags;\n\t\t}\n\t},\n\n\t/******* Cache **********/\n\n\t// The number of old posts that will be kept in the cache when it's cleared.\n\tPOST_CACHE_CLEAR_PRESERVED: 100,\n\t// The number of posts that are allowed to be cached before the cache is cleared.\n\tPOST_CACHE_CLEAR_THRESHOLD: 1000,\n\n\tcount_cached_posts: function() {\n\t\tvar cache = XKit.storage.get_all('retags');\n\t\treturn Object.keys(cache).filter(function(key) {\n\t\t\treturn key.match(/^post_[0-9]+$/);\n\t\t}).length;\n\t},\n\n\tshould_clear_posts: function() {\n\t\treturn XKit.extensions.retags.count_cached_posts() > XKit.extensions.retags.POST_CACHE_CLEAR_THRESHOLD || XKit.storage.quota('retags') < 100;\n\t},\n\n\tclear_old_posts: function() {\n\t\t// There's no API call to delete specific keys from the storage, so we'll\n\t\t// clear all of them and then restore the ones we want to keep.\n\t\tvar cache = XKit.storage.get_all('retags');\n\t\tXKit.storage.clear('retags');\n\n\t\t// We always want to keep every setting key, but we only want to keep\n\t\t// some of the cached posts, so we need to partition the keys like so.\n\t\tvar settingKeys = [], postIds = [];\n\t\tObject.keys(cache).forEach(function(key) {\n\t\t\tvar id_match;\n\t\t\tif ((id_match = key.match(/^post_([0-9]+)$/))) {\n\t\t\t\tpostIds.push(parseInt(id_match[1], 10));\n\t\t\t} else {\n\t\t\t\tsettingKeys.push(key);\n\t\t\t}\n\t\t});\n\n\t\t// Now sort the post IDs in descending order and take only the first\n\t\t// few, so we only keep the newest posts.\n\t\tpostIds.sort(function(id_one, id_two) { return id_two - id_one; });\n\t\tif (postIds.length > XKit.extensions.retags.POST_CACHE_CLEAR_PRESERVED) {\n\t\t\tpostIds.length = XKit.extensions.retags.POST_CACHE_CLEAR_PRESERVED;\n\t\t}\n\t\tpostIds.forEach(function(id) {\n\t\t\tsettingKeys.push('post_' + id);\n\t\t});\n\n\t\t// And finally write back to storage!\n\t\tsettingKeys.forEach(function(key) {\n\t\t\tXKit.storage.set('retags', key, cache[key].value);\n\t\t});\n\t},\n\n\t//********** Activity Page Toggle ********/\n\n\tadd_toggle: function() {\n\t\tvar toggle = 'toggle_' + this.blog_name;\n\t\tif (XKit.browser().mobile) {\n\t\t\tthis.html_toggle.appendTo('.primary-nav');\n\t\t\tXKit.tools.add_css('label.retags .binary_switch_label {font-size:15px; color:white; padding-bottom:15px; }', 'retags_mobile_label');\n\t\t} else {\n\t\t\tthis.html_toggle.appendTo('.ui_notes_switcher .part-toggle');\n\t\t}\n\t\t$('#retags-toggle').change(function() {\n\t\t\tif ($(this).prop('checked')) {\n\t\t\t\tXKit.storage.set('retags', toggle, 'true');\n\t\t\t\tXKit.extensions.retags.css_toggle.appendTo('head');\n\t\t\t\tif (XKit.browser().mobile) {\n\t\t\t\t\tXKit.extensions.retags.mobile_toggle.appendTo('head');\n\t\t\t\t}\n\t\t\t} else {\n\t\t\t\tXKit.storage.set('retags', toggle, 'false');\n\t\t\t\tXKit.extensions.retags.css_toggle.detach();\n\t\t\t}\n\t\t});\n\t\tif (XKit.storage.get('retags', toggle) === 'true') {\n\t\t\t$('#retags-toggle').click();\n\t\t}\n\t},\n\n\tcss_toggle:\n\t$('<style class=\"retags\"> ' +\n\t\t'.ui_note, .ui_notes .activity-notification { display: none; } ' +\n\t\t'.ui_note.is_retags, .ui_note.is_reply, .ui_note.is_response, .ui_note.is_user_mention { display: block; } ' +\n\t\t'.activity-notification.is_retags, .activity-notification.is_reply, .activity-notification.is_reblog:not(.naked), .activity-notification.user_mention, .activity-notification.note_mention { display: flex; }' +\n\t'</style>'),\n\n\tmobile_toggle:\n\t$('<style class=\"retags\">' +\n\t\t'.note, .mh_post.post.post_type_notification.notification { display: none; } ' +\n\t\t'.note.with_commentary, .note.is_reply, .mh_post.post.post_type_notification.notification.is_retags { display: block; }' +\n\t'</style>'),\n\n\thtml_toggle:\n\t$('<label class=\"retags binary_switch\">' +\n\t\t'<input id=\"retags-toggle\" type=\"checkbox\">' +\n\t\t'<span class=\"binary_switch_track\"></span>' +\n\t\t'<span class=\"binary_switch_button\"></span>' +\n\t\t'<span class=\"binary_switch_label\">Show only retags / responses</span>' +\n\t'</label>'),\n\n\tdestroy: function() {\n\t\tthis.running = false;\n\t\tXKit.tools.remove_css(\"retags\");\n\t\tXKit.tools.remove_css('retags_mobile');\n\t\tthis.css_toggle.detach();\n\t\tthis.html_toggle.detach();\n\t\tthis.mobile_toggle.detach();\n\t\tthis.observer.disconnect();\n\t\t$('.retags').remove();\n\t\t$('body').off('.retags');\n\t}\n};\n","file":"found","server":"up","errors":false,"icon":"data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAEAAAABACAIAAAAlC+aJAAAAGXRFWHRTb2Z0d2FyZQBBZG9iZSBJbWFnZVJlYWR5ccllPAAAAyJpVFh0WE1MOmNvbS5hZG9iZS54bXAAAAAAADw/eHBhY2tldCBiZWdpbj0i77u/IiBpZD0iVzVNME1wQ2VoaUh6cmVTek5UY3prYzlkIj8+IDx4OnhtcG1ldGEgeG1sbnM6eD0iYWRvYmU6bnM6bWV0YS8iIHg6eG1wdGs9IkFkb2JlIFhNUCBDb3JlIDUuMC1jMDYwIDYxLjEzNDc3NywgMjAxMC8wMi8xMi0xNzozMjowMCAgICAgICAgIj4gPHJkZjpSREYgeG1sbnM6cmRmPSJodHRwOi8vd3d3LnczLm9yZy8xOTk5LzAyLzIyLXJkZi1zeW50YXgtbnMjIj4gPHJkZjpEZXNjcmlwdGlvbiByZGY6YWJvdXQ9IiIgeG1sbnM6eG1wPSJodHRwOi8vbnMuYWRvYmUuY29tL3hhcC8xLjAvIiB4bWxuczp4bXBNTT0iaHR0cDovL25zLmFkb2JlLmNvbS94YXAvMS4wL21tLyIgeG1sbnM6c3RSZWY9Imh0dHA6Ly9ucy5hZG9iZS5jb20veGFwLzEuMC9zVHlwZS9SZXNvdXJjZVJlZiMiIHhtcDpDcmVhdG9yVG9vbD0iQWRvYmUgUGhvdG9zaG9wIENTNSBNYWNpbnRvc2giIHhtcE1NOkluc3RhbmNlSUQ9InhtcC5paWQ6MDA5QTFGNzNEOEYzMTFFM0ExRkJBMjU3NUY4MjNFRjciIHhtcE1NOkRvY3VtZW50SUQ9InhtcC5kaWQ6MDA5QTFGNzREOEYzMTFFM0ExRkJBMjU3NUY4MjNFRjciPiA8eG1wTU06RGVyaXZlZEZyb20gc3RSZWY6aW5zdGFuY2VJRD0ieG1wLmlpZDowMDlBMUY3MUQ4RjMxMUUzQTFGQkEyNTc1RjgyM0VGNyIgc3RSZWY6ZG9jdW1lbnRJRD0ieG1wLmRpZDowMDlBMUY3MkQ4RjMxMUUzQTFGQkEyNTc1RjgyM0VGNyIvPiA8L3JkZjpEZXNjcmlwdGlvbj4gPC9yZGY6UkRGPiA8L3g6eG1wbWV0YT4gPD94cGFja2V0IGVuZD0iciI/PpAlVCQAAAVxSURBVHja7Fp7bFNVGP/d29LHxgZ7m73kpRKjqP9ojAmwIEYFQYn/zUQji8ZHopigxgQFQggiOBOYomhiovuDDCMxIWqMMZj4py+CL/Zoe1v2hjHZuq5bW8937+2aQe+95z7aroaTk5umPff7ft/7O+dUOONJoZiHG2JR4y92+MwCgoDrLlRYAdzFLkCxu5CA/2kM3BuEq8wiUel9SLsK7UKW0bPR/Dy8DejeXsxZqG4rmGq623JfyFgdyDodkGELbv4YWvSdmrmtA7Vb6Nn9bE5dyJVbE5MMzJeeWxh1YPwXBPZi8mcZ2VNY8RpcizlkeCSHMrgFbguM/4o/ttEH5ZWRzxA9hzu+5LPDZnr2vJiLblRE9nnNCO67es3k7xg+ze1Lm7GqA5rsrE4TFoiexbWLx75H7SZuGTZR3uh5qUAulHWlr8kcv5qHKR56dxTChWpasyyraDHNsuYhrGwvhAstewXRv8mR5kbjDpTfaUVtTAbmS70785tGXaW4vROj3+DSD/A1YOlai+iVUf0gPXtftR8DbtOMFd72B9ER0fd6MW8pqx+gZ98beclCOZUhsKs4LZCRQUDgzbzEQK5k2Eh5KbCnmDf1VffLvrTX7IZGRNY5/FVhZFj+FrQgZZ2aFgi3U+Kv2pB3GTakG0f7MRA6QCJWthRABsY3uN+JLBQ8QM/8y6BwVLjbrQOhdyjHVa43phUfxpWzmPgTi29VI9KuDAJCB50oZNJhWYZ1emv6P8fwifQm4Ttc/BpNL8PfZE+G9cRXOmStnZ4/pXdx6Uc93Q93zVsf7UHkQyd8aR2ad+oBE357zMQVk381vHXZf7p8hp4VG1G2hqSFTLV0DVbtdkCMoS8w2KnlQmZaidh5mtn3awqdGVTch1QckQ55F3oOPbvR2AZfoy0BfMuhhZMqgYMzOavGX8ML6jdsDxQ+bgv9lITwUU2Oeq2EfwVq2Dbcq/qD4Ugl4KlO5/IWIhw5Tu9OncfYT2QZK+jD6NuD5BS0cOoVsrrHUX6XrTwoeBA5JvtStxUBGPrAPiTj0AGpZwH7jaqnStVcfNQ8+ggC+5HQ1r2JdjqVxPQQUtNGt7JJOmmc86LJf+imQ6Ffutoc+lgEwbeRnDZWom47nf5pZgx9zJQxY8bl96D5GRl9N6QOJCaJiHsJKteaQX8BgYNIRMHT6nNVYiWFca2UWUb7EP6ABFZeSc3AXW4CffBQ5l2Ogy0BelMeE3+RFxmslKerhBAw9Ez3Ygn8K+lLFoWsQeJFfzite76pFwOKDlgHMdQlG4Gj5MXCkI4RAtFD9YtFTkxSbcI6PIN3+xFq5/J73krMflLQUxTehPhFzF42IDd9QTarGze0ouw2yoMKfZfPGL30noze5CGDXgyMfoupXrJDyS2ofwKhIxCucBGtfRRL71ZDQqWvCys2AOmInO/Nn/HobWimAsTYvwwNT0L0ITXL++cW9komj4nzElp29EdJ99YOeAyykK8JjU9TaDIGzK3FRVx5IQM3bQEtx5gepIhPWdK9sQW89aR75RZMWITG7dTtcKTSTC3LOI+QHT2LeMu6Nw7ipjY6mJgLaE+NaerKyYem7j+i6i7YOxrUs0B8BP5Se81QUtXuVZmRoWeNqk3dGwvQ30nJx3+j2g6xjE5xzHmSJ2L2X9rjK/QVIhn0nyARd+b/bnpBnJzBwAmSwVdP7cBAl9zbmPUimT6rIb4GGf0QIp8SZadOxQ3OhRIxWYZWeGspC1Fza21Tewqz47SfHjxF+d7BI3G3aKSJZBRDJ1G3jUqBOGGd01j6UEN09EaCa1PPlDdy2oGMkYvBe8GhbqkWoABCsf/tsuB3ZHlyoQVsgesuVNjxnwADACKdjtGZRJ7nAAAAAElFTkSuQmCC","css":".ui_notes .date_header .part_full_date.stuck {\n    margin-left: 400px;\n    width: 165px;\n}\n\nlabel.retags {\n    margin-left: 15px;\n    top: -1px;\n}\n\nlabel.retags .binary_switch_label {\n    position: absolute;\n    top: 0;\n    left: 24px;\n    padding: 0 8px;\n    line-height: 14px;\n    white-space: nowrap;\n}\n\n.activity-notification {\n    flex-wrap: wrap;\n}\n\n.activity-notification div.retags {\n    width: 100%;\n    margin: -4px 0 0 0;\n    padding-left: 53px;\n    padding-right: 60px;\n}\n\n.is_retags .activity-notification__activity_message.conversational {\n    margin-bottom: 10px;\n}\n\ndiv.retags {\n    white-space: normal;\n    overflow-wrap: break-word;\n    margin-bottom: 10px;\n    font-size: 12px;\n    clear: both;\n}\n\ndiv.retags.error {\n    color: #c00000;\n}\n\ndiv.retags + div.retags:before {\n    color: #c00000;\n    content: \"Warning: You are running multiple copies of Retags.\";\n}\n\ndiv.retags + div.retags a {\n    display: none;\n}\n\ndiv.retags a {\n    color: #a7a7a7 !important;\n    position: relative;\n    margin-right: 11px;\n    text-decoration: none;\n}\n\ndiv.retags a:hover {\n    color: #969696 !important;\n}\n\n.note div.retags {\n    font-size: 12px;\n    line-height: 1.3;\n}\n\n.note div.retags a {\n    margin-right: 9px;\n}\n\n.post_notes .notes_outer_container.popover .note.with_commentary span.action {\n    min-height: 0;\n}\n\n.notification div.retags a {\n    color: rgba(255, 255, 255, 0.3) !important;\n}\n\n.notification div.retags a:hover {\n    color: rgba(255, 255, 255, 0.4) !important;\n}\n\n.retags-wrapper { list-style: none; padding-left: 30px;}\n\n.ui_note div.retags {\n    margin-top: 0;\n    padding-left: 45px;\n}\n\n.ui_note div.retags + div.retags {\n    margin-top: -5px;\n    padding-top: 0;\n}\n\n.ui_note .part_response + div.retags {\n    margin-top: -7px;\n    padding-top: 0;\n}\n\ndiv.retags a:after {\n    content: \"\\\\00a0  \";\n    font-size: 0;\n    line-height: 0;\n}\n","title":"Retags","description":"Adds tags to reblog notes","developer":"new-xkit","version":"1.2.5","frame":"false","beta":"false","slow":"false"}